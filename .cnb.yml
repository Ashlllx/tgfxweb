STAGE_IMAGE_BUILD_NOTIFY: &STAGE_IMAGE_BUILD_NOTIFY
  name: é•œåƒæ„å»ºæˆåŠŸé€šçŸ¥
  image: tencentcom/wecom-message
  settings:
    robot: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=87f15456-6d15-4f4e-b5b8-0306456b3c63
    msgType: markdown
    content: |
      ##### **[${CNB_REPO_NAME}](https://git.woa.com/${CNB_REPO_SLUG}) å‘å¸ƒå®Œæˆ ğŸ‰**

      > <font color="comment">æ„å»ºé“¾æ¥</font>ï¼š[#${CNB_BUILD_ID}](${CNB_BUILD_WEB_URL})
      > <font color="comment">æ‰§è¡Œå‘˜å·¥</font>ï¼š${CNB_BUILD_USER}
      > <font color="comment">æ„å»ºåˆ†æ”¯</font>ï¼š<font color="info">[$CNB_BRANCH](https://git.woa.com/${CNB_REPO_SLUG}/tree/${CNB_MERGE_REQUEST_BRANCH:-$CNB_BRANCH})</font>
      > <font color="comment">æäº¤ç¼–å·</font>ï¼š[${CNB_COMMIT_SHORT}](https://git.woa.com/${CNB_REPO_SLUG}/commit/${CNB_COMMIT_SHORT})
      > <font color="comment">æäº¤å†…å®¹</font>ï¼š\`${CNB_COMMIT_MESSAGE_TITLE}\`
      > <font color="comment">é•œåƒæ ‡ç­¾</font>ï¼š\`${DOCKER_TAG}\`
      > <font color="comment">é•œåƒåœ°å€</font>ï¼š\`${DOCKER_IMAGE}:${DOCKER_TAG}\`

      ç‰ˆæœ¬å·²æ›´æ–°ï¼Œç‚¹å‡»æŸ¥çœ‹ ğŸ‘‰ <https://pag.io>


master:
  push:
    - git:
        enable: true
        submodules: false
      docker:
        image: node:20
      imports:
        - https://cnb.woa.com/pag/secrets/-/blob/main/cos.env.yml
      stages:
        - name: å®‰è£…ä¾èµ– & æ¨é€åˆ° COS
          script:
            # - export
            - cd website
            - node -v
            - yarn install
            - yarn build
            - wget https://github.com/tencentyun/coscli/releases/download/v1.0.6/coscli-v1.0.6-linux-amd64 -O coscli
            - chmod +x coscli
            - ./coscli config add --init-skip=true -b $COS_BUCKET -r $COS_REGION -e cos-internal.$COS_REGION.tencentcos.cn
            - ./coscli config set --secret_id $COS_SECRET_ID --secret_key $COS_SECRET_KEY
            # - ./coscli config show
            - ./coscli cp ./build/pag.qq.com/ cos://$COS_BUCKET/ -r
        - name: åˆ·æ–° CDN ç¼“å­˜
          image: tencentcom/tencentyun-cdn-purge:latest
          settings:
            secretId: $COS_SECRET_ID
            secretKey: $COS_SECRET_KEY
            urls:
              - https://pag.qq.com/ # åˆ·æ–°ç›®å½•éœ€è¦ä»¥ / ç»“å°¾
              - https://pag.io/
            flushType: flush # flush: ä»…åˆ·æ–°æ›´æ–°çš„æ–‡ä»¶ï¼Œdelete: åˆ·æ–°å…¨éƒ¨èµ„æº
            endpoint: cdn.internal.tencentcloudapi.com # å†…éƒ¨ AKSK è°ƒç”¨éœ€è¦ä½¿ç”¨å†…éƒ¨åŸŸå
        - *STAGE_IMAGE_BUILD_NOTIFY
